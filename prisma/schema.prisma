datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * Invitations Schema
 *
 * Stores organization invitation data for user-facing queries.
 * Logto Management API doesn't support user-scoped invitation queries,
 * so we store minimal metadata here to show users their pending invitations.
 */

// ============================================
// ORGANIZATION INVITATIONS
// ============================================

model Invitation {
  /// Unique identifier for the invitation record
  id String @id @default(cuid())

  /// Logto's invitation ID (from Management API response)
  logtoInvitationId String @unique

  /// Logto organization ID (workspace)
  workspaceId String

  /// Email address of the invitee
  inviteeEmail String

  /// Invitation status
  status InvitationStatus @default(PENDING)

  /// When the invitation expires (Unix timestamp in milliseconds)
  expiresAt DateTime

  /// When the invitation was created
  createdAt DateTime @default(now())

  /// When the invitation was last updated
  updatedAt DateTime @updatedAt

  @@index([inviteeEmail])
  @@index([workspaceId])
  @@index([expiresAt])
  @@index([status])
  @@map("invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
}

// ============================================
// API KEYS
// ============================================

/**
 * API Keys Schema
 *
 * Stores API keys for workspace authentication to the public API.
 * Uses scope-based permissions independent of the internal RBAC system.
 */
model ApiKey {
  id String @id @default(cuid())

  /// Workspace ID from Logto (organization ID)
  workspaceId String

  /// User-provided name for the API key
  name String

  /// SHA-256 hash of the API key
  /// The actual key is never stored, only the hash
  keyHash String @unique

  /// Preview of the key (first 8 chars after prefix)
  /// Format: "sk_abc12345..."
  /// Used for identification in the UI
  keyPreview String

  /// Array of scope names granted to this key
  /// @example ["read:contacts", "write:broadcasts"]
  scopes String[]

  /// Last time this key was used to make an API request
  lastUsedAt DateTime?

  /// When the key was created
  createdAt DateTime @default(now())

  /// When the key was last updated
  updatedAt DateTime @updatedAt

  /// Indexes for efficient queries
  @@index([workspaceId])
  @@index([keyHash])
  @@index([createdAt])
  @@map("api_keys")
}
