services:
  postgres:
    image: postgres:18-alpine
    container_name: starterkit-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "15432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - starterkit-network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: starterkit-rabbitmq
    ports:
      - "5672:5672" # AMQP
      - "15672:15672" # Management UI
    volumes:
      - ./data/rabbitmq:/var/lib/rabbitmq
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 1s
      timeout: 1s
      retries: 30
    networks:
      - starterkit-network

  logto:
    container_name: starterkit-logto
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - 3001:3001
      - 3002:3002
    entrypoint: ["sh", "-c", "npm run cli db seed -- --swe && npm start"]
    image: svhd/logto:latest
    environment:
      - TRUST_PROXY_HEADER=1
      - DB_URL=postgresql://postgres:postgres@postgres:5432/logto
      - ENDPOINT
      - ADMIN_ENDPOINT
    networks:
      - starterkit-network

  outpost-api:
    image: hookdeck/outpost:v0.7.0
    container_name: starterkit-outpost-api
    env_file: .env.local
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./webhooks/config/outpost:/config/outpost
    environment:
      SERVICE: api
      POSTGRES_URL: postgres://outpost:outpost@postgres:5432/outpost?sslmode=disable
      RABBITMQ_SERVER_URL: amqp://guest:guest@rabbitmq:5672
      API_KEY: "${OUTPOST_API_KEY}"
      API_JWT_SECRET: "${OUTPOST_API_JWT_SECRET}"
      AES_ENCRYPTION_SECRET: "${OUTPOST_AES_ENCRYPTION_SECRET}"
      REDIS_HOST: "${OUTPOST_REDIS_HOST}"
      REDIS_PORT: "${OUTPOST_REDIS_PORT}"
      REDIS_PASSWORD: "${OUTPOST_REDIS_PASSWORD}"
      REDIS_DATABASE: "${OUTPOST_REDIS_DATABASE}"
    ports:
      - "3333:3333"
    networks:
      - starterkit-network

  outpost-delivery:
    image: hookdeck/outpost:v0.7.0
    container_name: starterkit-outpost-delivery
    env_file: .env.local
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./webhooks/config/outpost:/config/outpost
    environment:
      SERVICE: delivery
      POSTGRES_URL: postgres://outpost:outpost@postgres:5432/outpost?sslmode=disable
      RABBITMQ_SERVER_URL: amqp://guest:guest@rabbitmq:5672
      API_KEY: "${OUTPOST_API_KEY}"
      API_JWT_SECRET: "${OUTPOST_API_JWT_SECRET}"
      AES_ENCRYPTION_SECRET: "${OUTPOST_AES_ENCRYPTION_SECRET}"
      REDIS_HOST: "${OUTPOST_REDIS_HOST}"
      REDIS_PORT: "${OUTPOST_REDIS_PORT}"
      REDIS_PASSWORD: "${OUTPOST_REDIS_PASSWORD}"
      REDIS_DATABASE: "${OUTPOST_REDIS_DATABASE}"
    networks:
      - starterkit-network

  outpost-log:
    image: hookdeck/outpost:v0.7.0
    container_name: starterkit-outpost-log
    env_file: .env.local
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    volumes:
      - ./webhooks/config/outpost:/config/outpost
    environment:
      SERVICE: log
      POSTGRES_URL: postgres://outpost:outpost@postgres:5432/outpost?sslmode=disable
      RABBITMQ_SERVER_URL: amqp://guest:guest@rabbitmq:5672
      API_KEY: "${OUTPOST_API_KEY}"
      API_JWT_SECRET: "${OUTPOST_API_JWT_SECRET}"
      AES_ENCRYPTION_SECRET: "${OUTPOST_AES_ENCRYPTION_SECRET}"
      REDIS_HOST: "${OUTPOST_REDIS_HOST}"
      REDIS_PORT: "${OUTPOST_REDIS_PORT}"
      REDIS_PASSWORD: "${OUTPOST_REDIS_PASSWORD}"
      REDIS_DATABASE: "${OUTPOST_REDIS_DATABASE}"
    networks:
      - starterkit-network

  redis:
    image: redis:7.4-alpine
    container_name: starterkit-redis
    restart: always
    env_file: .env.local
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    command: >
      redis-server
        --save 20 1
        --requirepass ${REDIS_PASSWORD}
    volumes:
      - ./data/redis:/data
    networks:
      - starterkit-network

  garage:
    image: dxflrs/garage:v1.1.0
    container_name: starterkit-garage
    restart: unless-stopped
    environment:
      - RUST_LOG=garage=info
    ports:
      - "3900:3900"  # S3 API
      - "3901:3901"  # RPC (inter-node communication)
      - "3902:3902"  # S3 Web hosting
      - "3903:3903"  # Admin API & Metrics
    volumes:
      - ./garage/config/garage.toml:/etc/garage.toml:ro
      - ./garage/meta:/var/lib/garage/meta
      - ./garage/data:/var/lib/garage/data
    networks:
      - starterkit-network
    healthcheck:
      test: ["CMD", "garage", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  postgres_data:
    driver: local

networks:
  starterkit-network:
    driver: bridge
